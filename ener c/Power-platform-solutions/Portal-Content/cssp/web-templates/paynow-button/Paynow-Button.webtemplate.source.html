{% if billHeader.cssp_amountdue <= 0 %}
    <div id="cssp-paid-label" class="text-center mr-3">
        <span class="glyphicon glyphicon-check">&nbsp;No Payment Required</span>
    </div>
{% else %}
    <button id="cssp-paid-paynow-btn" class="btn btn-primary btn-block" disabled><i class="fa fa-spinner fa-spin"></i>&nbsp;Loading</button>
{% endif %}
<script type="module">
import { LoadingService as Loading } from "/Loading.js";
import { HttpService as Http } from "/http.js";
import { UserService } from "/UserService.js";

 const PaynowButton = {
    payNow: async () => {
        Loading.show();
        const userDetails = UserService.getUserDetails();
        const uiUrl = userDetails['ui-url'];
        const callRedMaple = userDetails['call-red-maple'];

        const transactionId = await PaynowButton.getTransactionId(callRedMaple, userDetails);

        const paynowURL = uiUrl + '/transaction/' + transactionId;

        //const windowHandler = window.open(addURL)!;
        const rmiFrame = document.querySelector("#iframeModalWindow");
        rmiFrame.src = paynowURL;

        var logoRMModal = document.querySelector('.imgLogoRMModal');
        logoRMModal.style.display = 'none';
        if ("{{logo['sc.cssp_logourl']}}") logoRMModal.src = "{{logo['sc.cssp_logourl']}}";
        else logoRMModal.src = "/logo"
        logoRMModal.style.display = 'block';

        Loading.hide();
        $('#rm-Modal').modal({ backdrop: 'static', keyboard: false, }).show();
        const cancelBtn = document.querySelector('.closeRmModal');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', (event) => {
                Loading.show();
                window.location.reload();
            });
        }
    },
    getTransactionId: async(callRedMaple, userDetails) => {
        const billHeaderId = userDetails['bill-header'] ? userDetails['bill-header'].id : "" + Date.now();
        let transactionId = '';
        let responseText = await Http.post(callRedMaple, {
            "orderId": billHeaderId,
            "invoiceId": billHeaderId,
            "customerId": userDetails['id'],
            "action":"gettrid",
            "token": ""
        });

        let response = responseText ? JSON.parse(responseText) : {};

        if (response.id) {
            transactionId = response.id;
        }
        else {
            responseText = await Http.post(callRedMaple,
                {
                    "orderId": billHeaderId,
                    "invoiceId": billHeaderId,
                    "customerId": userDetails['id'],
                    "action":"trcreate",
                    "token": ""
                });
            response = JSON.parse(responseText);

            if (response.isSuccess) {
                transactionId = response.transaction.id;
            }
            else {
                alert('An error occurred:\n' + response.message);
                Loading.hide();
                return;
            }
        }
        return transactionId;
    },

}
const payNowBtn = document.querySelector('#cssp-paid-paynow-btn');
payNowBtn ? payNowBtn.addEventListener('click', (event) => { PaynowButton.payNow(event); }) : null;

</script>