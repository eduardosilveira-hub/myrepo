$(() => {
	this.retrieveProduct();
});

function retrieveProduct() {
	
	parent.Xrm.WebApi.retrieveMultipleRecords("product", "?$select=productid,name,productstructure,_parentproductid_value&$filter=productstructure eq 2 and _parentproductid_value eq null").then(
		function success(rootresult) {
			for (var i = 0; i < rootresult.entities.length; i++) {
				console.log(rootresult.entities[i]);
products.push({id:rootresult.entities[i].productid, name:rootresult.entities[i].name})
			}                    

			// perform additional operations on retrieved records
			
			 parent.Xrm.WebApi.retrieveMultipleRecords("product", "?$select=productid,name,productstructure,_parentproductid_value&$filter=productstructure eq 2 and _parentproductid_value ne null").then(
				function success(childresult) {
					for (var i = 0; i < childresult.entities.length; i++) {
						console.log(childresult.entities[i]);
products.push({id:childresult.entities[i].productid, name:childresult.entities[i].name, parentId:childresult.entities[i]._parentproductid_value})
					}                    
					// perform additional operations on retrieved records
					
					$('#simple-treeview').dxTreeView({
						items: products,
						dataStructure: 'plain',
						parentIdExpr: 'parentId',
						keyExpr: 'id',
						displayExpr: 'name',
						width: 300,
						onItemClick(e) {
						  const item = e.itemData;
if(e.node.children.length == 0){
//alert(item.name);
window.returnValue = {"id":item.id,"name":item.name};
                window.close();
}

						  /*if (item.price) {
							$('#product-details').removeClass('hidden');
							$('#product-details > img').attr('src', item.image);
							$('#product-details > .price').text(`$${item.price}`);
							$('#product-details > .name').text(item.text);
						  } else {
							$('#product-details').addClass('hidden');
						  }
*/
						},
					}).dxTreeView('instance');
				},
				function (error) {
					document.querySelector("#simple-treeview").innerHTML = 'Please try closing this pop-up and searching again.';
					console.log(`There was an error processing the request: ${error.message}.`);
					// handle error conditions
				}
			);
		},
		function (error) {
			document.querySelector("#simple-treeview").innerHTML = 'Please try closing this pop-up and searching again.';
			console.log(`There was an error processing the request: ${error.message}.`);
			// handle error conditions
		}
	);
};

var products = [];
/*
const products = [
    { id: '1', name: 'Fruits' },     // A root item
    { id: '1_1', name: 'Apples', parentId: '1' },
    { id: '1_2', name: 'Oranges', parentId: '1' },
    { id: '2', name: 'Vegetables' }, // Also a root item
    { id: '2_1', name: 'Cucumbers', parentId: '2' },
    { id: '2_2', name: 'Tomatoes', parentId: '2' }
];
*/